# 맵 마커 등록기 v1.8

ROS 맵 이미지에서 경로(Path)의 시작점(Start), 목적지(Goal), 경유점(Waypoint)을 시각적으로 등록하고 관리하는 GUI 애플리케이션입니다.

## 주요 기능

### 1. 맵 로드 및 관리
- **YAML 파일 지원**: ROS `map_server` 형식의 YAML 파일을 불러와 맵 메타데이터 자동 파싱
- **이미지 자동 로드**: YAML 파일에 지정된 이미지 경로를 자동으로 찾아 로드
- **맵 메타데이터 표시**: resolution, origin, yaw 정보를 실시간으로 표시

### 2. 로봇 배리어 생성 및 표시
- **배리어 자동 생성**: 로봇 크기(가로/세로)를 입력하여 장애물 영역을 자동으로 확장
- **타원형 커널 사용**: 로봇의 실제 형태를 고려한 타원형 확장
- **반투명 오버레이**: 배리어 영역을 반투명 빨간색으로 표시
- **배리어 표시/숨김**: 체크박스로 배리어 표시 여부 제어
- **배리어 영역 검증**: Start, Goal, Waypoint 입력 시 배리어 영역에 생성 불가

### 3. 경로 입력 (Episode 기능)
#### 3.1 새 경로 입력
1. **"새 경로 입력"** 버튼 클릭
2. **Start 입력**: 캔버스에서 좌클릭 후 드래그하여 시작점과 방향 설정
3. **Goal 입력**: 캔버스에서 좌클릭 후 드래그하여 목적지와 방향 설정
4. **Waypoint 입력**: 캔버스에서 좌클릭하여 경유점 추가 (방향 없음, 점만)
5. **"경로 입력 완료"** 버튼 클릭

#### 3.2 경로 연결 및 시각화
- **자동 경로 연결**: Start → Waypoints → Goal 순서로 자동 연결
- **화살표 표시**: 경로 방향을 나타내는 화살표 자동 생성
- **실시간 미리보기**: Start/Goal 입력 시 드래그 방향을 실시간으로 미리보기

#### 3.3 Start/Goal 고정 모드
- **여러 Trajectory 생성**: Start와 Goal을 고정한 상태에서 여러 경로 생성 가능
- **경로 입력 완료 후 선택**: 
  - **Yes**: Start/Goal을 새로 입력하여 새로운 Episode 시작
  - **No**: Start/Goal을 고정하고 추가 경로 입력 계속

### 4. 줌 및 팬 기능
- **줌 인/아웃**: `Ctrl + 마우스 휠`로 확대/축소
  - 마우스 커서 위치를 중심으로 줌
  - 줌 범위: 0.1x ~ 10.0x
  - Barrier도 줌 레벨에 맞춰 자동 확대/축소
- **팬 (이동)**: 가운데 버튼(휠 클릭) 드래그로 맵 이동
- **스크롤**: 마우스 휠로 수직 스크롤, `Shift + 휠`로 수평 스크롤

### 5. 마커 목록 관리
- **마커 목록 표시**: 모든 마커를 리스트로 표시
  - 마커 ID, 타입(Start/Goal/Waypoint), route_id, seq, 좌표, 각도 정보
  - 마커 소스 표시: L(Live), S(Saved), F(File)
- **호버 기능**: 마커 목록에서 마커에 마우스를 올리면
  - 해당 마커의 route만 캔버스에 표시
  - 다른 route는 자동으로 숨김
  - 마우스를 벗어나면 모든 route 다시 표시
- **선택 및 하이라이트**: 
  - 마커 클릭 시 해당 위치로 자동 스크롤
  - 선택된 마커는 초록색 하이라이트 표시
  - 호버된 마커는 주황색 하이라이트 표시
- **선택 삭제**:
  - **Waypoint 삭제**: 선택한 Waypoint만 삭제
  - **Start/Goal 삭제**: 해당 route의 모든 마커(Start, Goal, 모든 Waypoint) 자동 삭제
  - 경로 선분도 자동으로 삭제됨

### 6. 경로 표시 옵션
- **이전 라이브 경로 숨김**: 체크박스로 최신 경로만 표시하거나 모든 경로 표시
- **Saved 마커 관리**: 완료된 경로는 Saved 상태로 전환되어 GUI에서 숨김 (데이터는 유지)

### 7. 저장 및 불러오기
#### 7.1 저장 (JSON 형식)
- **JSON 형식 저장**: 모든 마커 정보를 JSON 파일로 저장
- **메타데이터 포함**: YAML 경로, 이미지 경로, resolution, origin 등 저장
- **좌표계 변환**: 이미지 픽셀 좌표와 맵 좌표계 좌표 모두 저장
- **마커 정보**: ID, 타입, route_id, seq, 좌표, 각도 등 상세 정보 저장

#### 7.2 불러오기
- **JSON 파일**: 이전에 저장한 JSON 파일 불러오기
- **TXT/CSV 파일**: 레거시 형식의 텍스트/CSV 파일 지원
- **자동 좌표 변환**: 파일 형식에 따라 자동으로 좌표계 변환
- **메타데이터 복원**: 저장된 메타데이터를 자동으로 복원

### 8. 성능 최적화
- **이미지 캐싱**: Barrier 이미지를 캐싱하여 반복 생성 방지
- **스마트 리사이즈**: 
  - Barrier: NEAREST 알고리즘 사용 (빠른 처리)
  - 맵 이미지: 크기에 따라 BILINEAR/LANCZOS 자동 선택
- **효율적인 렌더링**: 줌 레벨 변경 시에만 이미지 리사이즈

## 사용 방법

### 기본 워크플로우

1. **맵 로드**
   ```
   "YAML 열기..." 버튼 클릭 → YAML 파일 선택
   ```

2. **배리어 생성 (선택사항)**
   ```
   로봇 가로/세로 입력 → "배리어 생성" 버튼 클릭
   ```

3. **경로 입력**
   ```
   "새 경로 입력" 버튼 클릭
   → Start 클릭 후 드래그 (방향 설정)
   → Goal 클릭 후 드래그 (방향 설정)
   → Waypoint들을 클릭하여 추가
   → "경로 입력 완료" 버튼 클릭
   ```

4. **저장**
   ```
   "저장(.json)" 버튼 클릭 → 파일명 입력 → 저장
   ```

### 키보드 및 마우스 단축키

| 동작 | 단축키 |
|------|--------|
| 줌 인 | `Ctrl + 마우스 휠 위로` |
| 줌 아웃 | `Ctrl + 마우스 휠 아래로` |
| 팬 (이동) | `가운데 버튼 드래그` |
| 수직 스크롤 | `마우스 휠` |
| 수평 스크롤 | `Shift + 마우스 휠` |
| Start/Goal 입력 | `좌클릭 후 드래그` |
| Waypoint 입력 | `좌클릭` |

## 좌표계 정보

### 이미지 좌표계
- **원점**: 왼쪽 상단 (0, 0)
- **X축**: 오른쪽 방향 (+X)
- **Y축**: 아래쪽 방향 (+Y)
- **각도**: 0° = 오른쪽 (+X), 90° = 아래 (+Y)

### 맵 좌표계
- **원점**: YAML 파일의 origin 설정
- **Y축**: 위쪽 방향 (+Y, ROS 표준)
- **각도**: 라디안 단위, YAML의 origin_yaw 기준

### 좌표 변환
- 이미지 픽셀 좌표 ↔ 맵 좌표계 자동 변환
- `use_center` 옵션: 픽셀 중심점 사용 여부

## 파일 형식

### JSON 저장 형식
```json
{
  "metadata": {
    "version": "1.8",
    "yaml_path": "/path/to/map.yaml",
    "image_path": "/path/to/map.pgm",
    "resolution": 0.05,
    "origin": [0.0, 0.0, 0.0],
    "use_center": true
  },
  "markers": [
    {
      "id": "mk_1234567890",
      "type": "start",
      "source": "live",
      "route_id": 1,
      "seq": 0,
      "u_px": 100.5,
      "v_px": 200.5,
      "theta_img_deg": 45.0,
      "x_map": 5.025,
      "y_map": 10.025,
      "theta_map_rad": 0.785
    }
  ]
}
```

## 요구사항

### 필수 패키지
```bash
pip install pillow pyyaml numpy scipy
```

### Python 버전
- Python 3.6 이상

### 운영체제
- Linux (X11)
- Windows
- macOS

## 주의사항

1. **배리어 영역**: Start, Goal, Waypoint는 배리어 영역에 생성할 수 없습니다.
2. **경로 삭제**: Start 또는 Goal을 삭제하면 해당 route의 모든 마커가 삭제됩니다.
3. **Saved 마커**: 완료된 경로는 GUI에서 숨겨지지만 데이터는 유지되며 저장 시 포함됩니다.
4. **이미지 크기**: 매우 큰 이미지의 경우 줌/팬 동작이 느려질 수 있습니다.

## 버전 히스토리

### v1.8
- New Episode 기능 추가
- Start/Goal 고정 후 여러 trajectory 생성 기능
- Path 연결 선분 및 화살표 표시
- Barrier 생성 및 표시 기능
- 줌/팬 기능 개선
- 성능 최적화 (이미지 캐싱)
- 마커 목록 호버 기능
- Start/Goal 삭제 시 route 전체 삭제 기능

## 라이선스

이 프로젝트는 ROS 맵 마커 등록을 위한 도구입니다.
